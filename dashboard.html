<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Controle de Almoxarifado</title>
    <link rel="stylesheet" href="./assets/style.css">
    <style>
        /* Estilos adicionais para modais */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border: 1px solid #ddd;
            width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            text-align: center;
        }
        .modal-content h2 {
            margin-bottom: 20px;
            color: #003087;
            font-size: 1.5em;
        }
        .modal-content input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .modal-content button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .modal-content .confirm-btn {
            background: #003087;
            color: white;
        }
        .modal-content .cancel-btn {
            background: #f5f5f5;
            color: #003087;
            border: 1px solid #ddd;
        }
        #editItemModal .form-group {
            text-align: left;
            margin-bottom: 15px;
        }
        #editItemModal label {
            display: block;
            margin-bottom: 5px;
            color: #003087;
            font-weight: bold;
        }
        #editItemModal select, #editItemModal textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        #editItemModal .image-preview {
            margin-top: 10px;
            max-width: 200px;
            max-height: 200px;
            display: none;
        }
        #editItemModal .image-preview img {
            width: 100%;
            height: auto;
            border-radius: 5px;
        }
        .quantidade-minima { color: red; }
        .disabled { opacity: 0.5; pointer-events: none; }
        .btn-excluir { background-color: #ff4444; color: white; border: none; padding: 6px 12px; cursor: pointer; border-radius: 4px; margin-right: 5px; }
        .btn-excluir:hover { background-color: #cc0000; }
        .btn-editar { background-color: #4CAF50; color: white; border: none; padding: 6px 12px; cursor: pointer; border-radius: 4px; margin-right: 5px; }
        .btn-editar:hover { background-color: #45a049; }

        /* Novos estilos para a modal de movimentações */
        #movimentacoesModal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        #movimentacoesModal .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border: 1px solid #ddd;
            width: 90%;
            max-width: 1200px;
            max-height: 85vh;
            overflow-y: auto;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            text-align: left;
        }
        #movimentacoesModal h2 {
            margin-bottom: 20px;
            color: #003087;
            font-size: 1.5em;
        }
        #movimentacoesModal .filter-buttons button {
            padding: 8px 15px;
            margin-right: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #movimentacoesModal .filter-buttons .date-filter {
            background: #007bff;
            color: white;
        }
        #movimentacoesModal .filter-buttons .exit-filter {
            background: #dc3545;
            color: white;
        }
        #movimentacoesModal .filter-buttons .clear-filter {
            background: #6c757d;
            color: white;
        }
        #movimentacoesModal .search-bar {
            display: flex;
            align-items: center;
            margin: 20px 0;
        }
        #movimentacoesModal .search-bar input {
            flex: 1;
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #movimentacoesModal .search-bar select {
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #movimentacoesModal .search-bar button {
            padding: 8px 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #movimentacoesModal table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        #movimentacoesModal th, #movimentacoesModal td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
            text-align: left;
        }
        #movimentacoesModal th {
            background-color: #003087;
            color: white;
        }
        #movimentacoesModal .item-img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
        }
    </style>
</head>
<body class="dashboard-page">
    <div class="header">
        <div class="logo-section">
            <img src="./Imagens/SENAI.PNG" alt="SENAI">
            <h1>Controle de Almoxarifado</h1>
        </div>
        <div class="system-info"></div>
        <div class="user-section">
            <span>Bem-vindo, <span id="userName">admin</span></span>
            <button class="logout-btn" onclick="logout()">Sair</button>
        </div>
    </div>

    <div class="search-bar">
        <input type="text" id="searchInput" placeholder="Buscar item por código, nome, etc..." oninput="filterTable()">
    </div>

    <div class="actions-bar">
        <button onclick="novoItem()">+ Novo</button>
        <button onclick="openMovimentacoesModal()">Movimentações</button>
        <button onclick="exportar()">Exportar</button>
        <!-- Botão visível só para admins -->
        <button id="gerenciarUsuariosBtn" onclick="openRegisterModal()" style="display: none;">Gerenciar Usuários</button>
    </div>

    <div class="table-container">
        <table id="itensTable">
            <thead>
                <tr>
                    <th>Imagem</th>
                    <th>Código</th>
                    <th>Setor</th>
                    <th>Descrição</th>
                    <th>Complemento</th>
                    <th>Un.</th>
                    <th>Qtd.</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <!-- Linhas populadas via JS -->
            </tbody>
        </table>
    </div>

    <div class="pagination">
        <button onclick="previousPage()" id="prevBtn" disabled>Anterior</button>
        <span id="pageInfo">Página 1 de 1</span>
        <button onclick="nextPage()" id="nextBtn">Próxima</button>
    </div>

    <!-- Modal para gerenciamento de usuários -->
    <div id="registerModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
        <div style="background-color: white; margin: 10% auto; padding: 30px; border: 1px solid #ddd; width: 500px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
            <h2 style="margin-bottom: 20px; color: #003087;">Gerenciar Usuários</h2>
            <div style="display: flex; margin-bottom: 20px; border-bottom: 1px solid #ddd;">
                <button id="cadastrarTab" onclick="switchTab('cadastrar')" style="flex: 1; padding: 10px; background: #003087; color: white; border: none; border-radius: 8px 8px 0 0; cursor: pointer;">Cadastrar Novo</button>
                <button id="excluirTab" onclick="switchTab('excluir')" style="flex: 1; padding: 10px; background: #f5f5f5; color: #003087; border: none; border-radius: 8px 8px 0 0; cursor: pointer;">Excluir Usuário</button>
            </div>

            <div id="cadastrarSection" style="display: block;">
                <form id="registerForm">
                    <div style="display: flex; gap: 20px; margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <label for="newEmail" style="display: block; margin-bottom: 5px; color: #003087; font-weight: bold;">E-mail:</label>
                            <input type="email" id="newEmail" placeholder="Digite o e-mail" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                        <div style="flex: 1;">
                            <label for="newPassword" style="display: block; margin-bottom: 5px; color: #003087; font-weight: bold;">Senha:</label>
                            <input type="password" id="newPassword" placeholder="Digite a senha" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        </div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="newRole" style="display: block; margin-bottom: 5px; color: #003087; font-weight: bold;">Role:</label>
                        <select id="newRole" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            <option value="user">User (Padrão)</option>
                            <option value="admin">Admin</option>
                            <option value="developer">Developer</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="submit" style="padding: 10px 20px; background: #003087; color: white; border: none; border-radius: 5px; cursor: pointer;">Cadastrar</button>
                        <button type="button" onclick="closeRegisterModal()" style="padding: 10px 20px; background: #f5f5f5; color: #003087; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;">Cancelar</button>
                    </div>
                    <div id="registerMsg" style="margin-top: 10px; font-weight: bold;"></div>
                </form>
            </div>

            <div id="excluirSection" style="display: none;">
                <div id="usersList" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
                    <!-- Lista de usuários carregada via JS -->
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px;">
                    <button onclick="closeRegisterModal()" style="padding: 10px 20px; background: #f5f5f5; color: #003087; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para edição de usuário -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <h2>Editar Role do Usuário</h2>
            <form id="editUserForm">
                <div class="form-group">
                    <label for="editUserEmail">E-mail:</label>
                    <input type="text" id="editUserEmail" readonly>
                </div>
                <div class="form-group">
                    <label for="editUserRole">Nova Role:</label>
                    <select id="editUserRole" required>
                        <option value="user">User</option>
                        <option value="admin">Admin</option>
                        <option value="developer">Developer</option>
                    </select>
                </div>
                <button type="submit" class="confirm-btn">Salvar Alterações</button>
                <button type="button" class="cancel-btn" onclick="closeEditUserModal()">Cancelar</button>
                <div id="editUserMsg" style="margin-top: 15px; font-weight: bold;"></div>
            </form>
        </div>
    </div>

    <!-- Modal para cadastrar novo item -->
    <div id="novoItemModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
        <div style="background-color: white; margin: 5% auto; padding: 30px; border: 1px solid #ddd; width: 650px; max-height: 85vh; overflow-y: auto; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
            <h2 style="margin-bottom: 20px; color: #003087;">Cadastrar Novo Item</h2>
            <form id="novoItemForm" enctype="multipart/form-data">
                <div style="display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 20px;">
                    <div style="margin-bottom: 15px;">
                        <label for="codigo" style="display: block; margin-bottom: 8px; color: #003087; font-weight: bold;">Código *</label>
                        <input type="text" id="codigo" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="setor" style="display: block; margin-bottom: 8px; color: #003087; font-weight: bold;">Setor *</label>
                        <input type="text" id="setor" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="nome" style="display: block; margin-bottom: 8px; color: #003087; font-weight: bold;">Nome *</label>
                        <input type="text" id="nome" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="complemento" style="display: block; margin-bottom: 8px; color: #003087; font-weight: bold;">Complemento *</label>
                        <input type="text" id="complemento" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="unidade" style="display: block; margin-bottom: 8px; color: #003087; font-weight: bold;">Unidade *</label>
                        <select id="unidade" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px;">
                            <option value="">Selecione...</option>
                            <option value="UN">UN</option>
                            <option value="KG">KG</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="qtdInicial" style="display: block; margin-bottom: 8px; color: #003087; font-weight: bold;">Quantidade Inicial *</label>
                        <input type="number" id="qtdInicial" min="0" required style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="qtdMinima" style="display: block; margin-bottom: 8px; color: #003087; font-weight: bold;">Quantidade Mínima</label>
                        <input type="number" id="qtdMinima" min="0" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="imagem" style="display: block; margin-bottom: 8px; color: #003087; font-weight: bold;">Imagem do Item</label>
                        <input type="file" id="imagem" accept="image/*,.webp" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px;">
                        <div id="imagemPreview" style="margin-top: 10px; max-width: 200px; max-height: 200px; display: none;">
                            <img id="previewImg" src="" alt="Preview" style="width: 100%; height: auto; border-radius: 5px;">
                        </div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="observacao" style="display: block; margin-bottom: 8px; color: #003087; font-weight: bold;">Observação (opcional)</label>
                        <textarea id="observacao" rows="4" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px;"></textarea>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="fornecedor" style="display: block; margin-bottom: 8px; color: #003087; font-weight: bold;">Fornecedor (opcional)</label>
                        <input type="text" id="fornecedor" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="notaFiscal" style="display: block; margin-bottom: 8px; color: #003087; font-weight: bold;">Nota Fiscal (opcional)</label>
                        <input type="text" id="notaFiscal" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="submit" style="padding: 12px 24px; background: #003087; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">Cadastrar Item</button>
                    <button type="button" onclick="closeNovoItemModal()" style="padding: 12px 24px; background: #f5f5f5; color: #003087; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; font-size: 16px;">Cancelar</button>
                </div>
                <div id="novoItemMsg" style="margin-top: 15px; font-weight: bold;"></div>
            </form>
        </div>
    </div>

    <!-- Modal para entrada de estoque -->
    <div id="stockEntryModal" class="modal">
        <div class="modal-content">
            <h2 id="stockModalTitle">Adicionar Estoque</h2>
            <input type="number" id="entryQuantity" min="1" placeholder="Quantidade" required>
            <button class="confirm-btn" onclick="confirmStockEntry()">Confirmar</button>
            <button class="cancel-btn" onclick="closeStockEntryModal()">Cancelar</button>
        </div>
    </div>

    <!-- Modal para edição de item -->
    <div id="editItemModal" class="modal">
        <div class="modal-content">
            <h2>Editar Item</h2>
            <form id="editItemForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="editCodigo">Código *</label>
                    <input type="text" id="editCodigo" required>
                </div>
                <div class="form-group">
                    <label for="editSetor">Setor *</label>
                    <input type="text" id="editSetor" required>
                </div>
                <div class="form-group">
                    <label for="editNome">Nome *</label>
                    <input type="text" id="editNome" required>
                </div>
                <div class="form-group">
                    <label for="editComplemento">Complemento *</label>
                    <input type="text" id="editComplemento" required>
                </div>
                <div class="form-group">
                    <label for="editUnidade">Unidade *</label>
                    <select id="editUnidade" required>
                        <option value="UN">UN</option>
                        <option value="KG">KG</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editQtdInicial">Quantidade Inicial *</label>
                    <input type="number" id="editQtdInicial" min="0" required>
                </div>
                <div class="form-group">
                    <label for="editQtdMinima">Quantidade Mínima</label>
                    <input type="number" id="editQtdMinima" min="0">
                </div>
                <div class="form-group">
                    <label for="editImagem">Imagem do Item</label>
                    <input type="file" id="editImagem" accept="image/*,.webp">
                    <div class="image-preview" id="editImagemPreview">
                        <img id="editPreviewImg" src="" alt="Preview">
                    </div>
                </div>
                <div class="form-group">
                    <label for="editObservacao">Observação (opcional)</label>
                    <textarea id="editObservacao" rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label for="editFornecedor">Fornecedor (opcional)</label>
                    <input type="text" id="editFornecedor">
                </div>
                <div class="form-group">
                    <label for="editNotaFiscal">Nota Fiscal (opcional)</label>
                    <input type="text" id="editNotaFiscal">
                </div>
                <button type="submit" class="confirm-btn">Salvar Alterações</button>
                <button type="button" class="cancel-btn" onclick="closeEditItemModal()">Cancelar</button>
                <div id="editItemMsg" style="margin-top: 15px; font-weight: bold;"></div>
            </form>
        </div>
    </div>

    <!-- Modal para movimentações -->
    <div id="movimentacoesModal" class="modal">
        <div class="modal-content">
            <h2>Histórico de Movimentações</h2>
            <div class="filter-buttons">
                <button class="date-filter" onclick="filterByDate()">Filtrar por Data</button>
                <button class="exit-filter" onclick="filterByExits()">Filtrar Saídas</button>
                <button class="clear-filter" onclick="clearFilters()">Limpar Filtros</button>
            </div>
            <div class="search-bar">
                <input type="text" id="movimentacaoSearch" placeholder="Buscar em movimentações (nesta página)..." oninput="filterMovimentacoes()">
                <select id="movimentacaoType">
                    <option value="">Todos</option>
                    <!-- Opções de setor serão preenchidas dinamicamente -->
                </select>
                <button onclick="exportVisible()">Exportar Visíveis</button>
            </div>
            <table id="movimentacoesTable">
                <thead>
                    <tr>
                        <th>Imagem</th>
                        <th>Tipo</th>
                        <th>Código</th>
                        <th>Nome</th>
                        <th>Qtd</th>
                        <th>Data</th>
                        <th>Obs.</th>
                        <th>NF</th>
                        <th>Usuário</th>
                    </tr>
                </thead>
                <tbody id="movimentacoesBody">
                    <!-- Linhas populadas via JS -->
                </tbody>
            </table>
            <button type="button" onclick="closeMovimentacoesModal()" style="padding: 10px 20px; background: #f5f5f5; color: #003087; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; margin-top: 20px;">Fechar</button>
        </div>
    </div>

    <script>
        // Variável global para currentUser
        let currentUser;

        // Placeholder inline SVG (base64) para evitar erros de rede
        const placeholderImg = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiBmaWxsPSIjQ0NDIi8+Cjx0ZXh0IHg9IjI1IiB5PSIyOCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjEyIiBmaWxsPSIjRkZGIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5JdGVtPC90ZXh0Pgo8L3N2Zz4K';

        let itens = [];
        let currentPage = 1;
        const itemsPerPage = 5;
        let movimentacoes = [];

        // Funções globais
        function logout() {
            console.log('Logout clicked');
            localStorage.removeItem('loggedUser');
            window.location.href = 'index.html';
        }

        function novoItem() {
            console.log('Novo Item clicked');
            if (!currentUser || currentUser.role !== 'admin') {
                alert('Apenas administradores podem cadastrar novos itens.');
                return;
            }
            document.getElementById('novoItemModal').style.display = 'block';
            document.getElementById('novoItemForm').reset();
            document.getElementById('imagemPreview').style.display = 'none';
            document.getElementById('novoItemMsg').textContent = '';
        }

        function closeNovoItemModal() {
            console.log('Close Novo Item Modal clicked');
            document.getElementById('novoItemModal').style.display = 'none';
            document.getElementById('novoItemForm').reset();
            document.getElementById('novoItemMsg').textContent = '';
            document.getElementById('imagemPreview').style.display = 'none';
        }

        function goToMovimentacoes() {
            console.log('Movimentações clicked');
            alert('Ir para página de movimentações (futuro)');
        }

        function exportar() {
            console.log('Exportar clicked');
            alert('Exportar para CSV/Excel (futuro)');
        }

        function openRegisterModal() {
            console.log('Open Register Modal clicked');
            if (!currentUser || currentUser.role !== 'admin') {
                alert('Apenas administradores podem gerenciar usuários.');
                return;
            }
            document.getElementById('registerModal').style.display = 'block';
            loadUsers();
        }

        function closeRegisterModal() {
            console.log('Close Register Modal clicked');
            document.getElementById('registerModal').style.display = 'none';
            document.getElementById('registerForm').reset();
            document.getElementById('registerMsg').textContent = '';
        }

        function switchTab(tab) {
            if (tab === 'cadastrar') {
                document.getElementById('cadastrarSection').style.display = 'block';
                document.getElementById('excluirSection').style.display = 'none';
                document.getElementById('cadastrarTab').style.background = '#003087';
                document.getElementById('cadastrarTab').style.color = 'white';
                document.getElementById('excluirTab').style.background = '#f5f5f5';
                document.getElementById('excluirTab').style.color = '#003087';
            } else {
                document.getElementById('cadastrarSection').style.display = 'none';
                document.getElementById('excluirSection').style.display = 'block';
                document.getElementById('cadastrarTab').style.background = '#f5f5f5';
                document.getElementById('cadastrarTab').style.color = '#003087';
                document.getElementById('excluirTab').style.background = '#003087';
                document.getElementById('excluirTab').style.color = 'white';
            }
        }

        async function loadUsers() {
            console.log('Loading users for:', currentUser.email);
            if (!currentUser || !currentUser.email) {
                document.getElementById('usersList').innerHTML = '<p style="color: red;">Erro: Usuário não autenticado.</p>';
                return;
            }
            try {
                const response = await fetch(`http://localhost:3000/api/users?requesterEmail=${encodeURIComponent(currentUser.email)}`);
                const data = await response.json();
                console.log('API Response:', data);
                if (data.success) {
                    const usersList = document.getElementById('usersList');
                    usersList.innerHTML = data.users.map(user => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee;">
                            <span>${user.email} (${user.role})</span>
                            <div>
                                <button class="btn-editar" onclick="openEditUserModal('${user.email}', '${user.role}')">Editar</button>
                                <button class="btn-excluir" onclick="deleteUser('${user.email}')">Excluir</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('usersList').innerHTML = '<p style="color: red;">Erro ao carregar usuários: ' + data.message + '</p>';
                }
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('usersList').innerHTML = '<p style="color: red;">Erro de conexão ao carregar usuários.</p>';
            }
        }

        async function deleteUser(userEmail) {
            if (!confirm(`Tem certeza que deseja excluir o usuário ${userEmail}?`)) return;

            const requesterEmail = currentUser.email;
            console.log('Deleting user:', userEmail, 'by:', requesterEmail);
            try {
                const response = await fetch('http://localhost:3000/api/delete-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userEmail, requesterEmail })
                });
                const data = await response.json();
                console.log('Delete Response:', data);
                if (data.success) {
                    alert(data.message);
                    loadUsers(); // Recarregar lista
                } else {
                    alert(data.message || 'Erro ao excluir usuário');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('Erro de conexão ao excluir usuário.');
            }
        }

        function openEditUserModal(email, currentRole) {
            console.log('Open Edit User Modal for:', email);
            if (!currentUser || currentUser.role !== 'admin') {
                alert('Apenas administradores podem editar usuários.');
                return;
            }
            document.getElementById('editUserModal').style.display = 'block';
            document.getElementById('editUserModal').dataset.userEmail = email;
            document.getElementById('editUserEmail').value = email;
            document.getElementById('editUserRole').value = currentRole;
            document.getElementById('editUserMsg').textContent = '';
        }

        function closeEditUserModal() {
            console.log('Close Edit User Modal clicked');
            document.getElementById('editUserModal').style.display = 'none';
            document.getElementById('editUserForm').reset();
            document.getElementById('editUserMsg').textContent = '';
        }

        function openStockEntryModal(id) {
            console.log(`Open Stock Entry Modal for Item ${id}`);
            if (!currentUser || currentUser.role !== 'admin') {
                alert('Apenas administradores podem adicionar estoque.');
                return;
            }
            document.getElementById('stockEntryModal').style.display = 'block';
            document.getElementById('stockEntryModal').dataset.itemId = id;
            document.getElementById('stockModalTitle').textContent = 'Adicionar Estoque';
            document.getElementById('stockEntryModal').dataset.action = 'add';
            document.getElementById('entryQuantity').value = '';
        }

        function closeStockEntryModal() {
            console.log('Close Stock Entry Modal clicked');
            document.getElementById('stockEntryModal').style.display = 'none';
        }

        async function confirmStockEntry() {
            console.log('Confirm Stock Entry');
            const id = document.getElementById('stockEntryModal').dataset.itemId;
            const quantity = document.getElementById('entryQuantity').value;
            if (!quantity || isNaN(quantity) || parseInt(quantity, 10) <= 0) {
                alert('Por favor, insira uma quantidade válida maior que 0.');
                return;
            }

            try {
                const response = await fetch('http://localhost:3000/api/add-stock', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ itemId: id, quantity: quantity, requesterEmail: currentUser.email })
                });
                const data = await response.json();
                console.log('Resposta do servidor:', data);

                if (data.success) {
                    alert(data.message);
                    closeStockEntryModal();
                    loadItens(); // Recarrega a tabela
                } else {
                    alert(data.message || 'Erro ao adicionar estoque');
                }
            } catch (error) {
                console.error('Erro na entrada:', error);
                alert('Erro de conexão. Verifique o servidor.');
            }
        }

        function openRemoveStockModal(id) {
            console.log(`Open Remove Stock Modal for Item ${id}`);
            if (!currentUser || currentUser.role !== 'admin') {
                alert('Apenas administradores podem remover estoque.');
                return;
            }
            document.getElementById('stockEntryModal').style.display = 'block';
            document.getElementById('stockEntryModal').dataset.itemId = id;
            document.getElementById('stockEntryModal').dataset.action = 'remove';
            document.getElementById('stockModalTitle').textContent = 'Remover Estoque';
            document.getElementById('entryQuantity').value = '';
        }

        async function confirmRemoveStock() {
            console.log('Confirm Remove Stock');
            const id = document.getElementById('stockEntryModal').dataset.itemId;
            const quantity = document.getElementById('entryQuantity').value;
            if (!quantity || isNaN(quantity) || parseInt(quantity, 10) <= 0) {
                alert('Por favor, insira uma quantidade válida maior que 0.');
                return;
            }

            try {
                const response = await fetch('http://localhost:3000/api/remove-stock', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ itemId: id, quantity: quantity, requesterEmail: currentUser.email })
                });
                const data = await response.json();
                console.log('Resposta do servidor:', data);

                if (data.success) {
                    alert(data.message);
                    closeStockEntryModal();
                    loadItens(); // Recarrega a tabela
                } else {
                    alert(data.message || 'Erro ao remover estoque');
                }
            } catch (error) {
                console.error('Erro na baixa:', error);
                alert('Erro de conexão. Verifique o servidor.');
            }
        }

        function openEditItemModal(id) {
            console.log(`Open Edit Item Modal for Item ${id}`);
            if (!currentUser || currentUser.role !== 'admin') {
                alert('Apenas administradores podem editar itens.');
                return;
            }
            const item = itens.find(i => i.id === id);
            if (item) {
                document.getElementById('editItemModal').style.display = 'block';
                document.getElementById('editItemModal').dataset.itemId = id;
                document.getElementById('editCodigo').value = item.codigo || '';
                document.getElementById('editSetor').value = item.setor || '';
                document.getElementById('editNome').value = item.nome || '';
                document.getElementById('editComplemento').value = item.complemento || '';
                document.getElementById('editUnidade').value = item.unidade || 'UN';
                document.getElementById('editQtdInicial').value = item.qtd_inicial || 0;
                document.getElementById('editQtdMinima').value = item.qtd_minima || 0;
                document.getElementById('editObservacao').value = item.observacao || '';
                document.getElementById('editFornecedor').value = item.fornecedor || '';
                document.getElementById('editNotaFiscal').value = item.nota_fiscal || '';
                const editPreviewImg = document.getElementById('editPreviewImg');
                const editImagemPreview = document.getElementById('editImagemPreview');
                if (item.imagem_path) {
                    editPreviewImg.src = `/${item.imagem_path}`;
                    editImagemPreview.style.display = 'block';
                } else {
                    editImagemPreview.style.display = 'none';
                }
                document.getElementById('editItemMsg').textContent = '';
            }
        }

        function closeEditItemModal() {
            console.log('Close Edit Item Modal clicked');
            document.getElementById('editItemModal').style.display = 'none';
            document.getElementById('editItemForm').reset();
            document.getElementById('editImagemPreview').style.display = 'none';
            document.getElementById('editItemMsg').textContent = '';
        }

        // Funções para a modal de movimentações
        function openMovimentacoesModal() {
            document.getElementById('movimentacoesModal').style.display = 'block';
            loadMovimentacoes();
            populateSetorOptions();
        }

        function closeMovimentacoesModal() {
            document.getElementById('movimentacoesModal').style.display = 'none';
        }

        async function loadMovimentacoes() {
            try {
                // Chama a API para carregar movimentações reais
                const response = await fetch('http://localhost:3000/api/movimentacoes');
                movimentacoes = await response.json();
                // Se não houver movimentações, usa os dados dos itens como base
                if (!movimentacoes.length) {
                    movimentacoes = itens.map(item => ({
                        id: item.id,
                        imagem_path: item.imagem_path || './Imagens/placeholder.png',
                        tipo: 'ESTOQUE INICIAL',
                        codigo: item.codigo,
                        nome: item.nome,
                        qtd: item.qtd_inicial,
                        data: new Date().toLocaleString('pt-BR'),
                        obs: item.observacao || '',
                        nf: item.nota_fiscal || '',
                        usuario: currentUser.email || 'Sistema'
                    }));
                }
                renderMovimentacoes();
            } catch (error) {
                console.error('Erro ao carregar movimentações:', error);
                // Fallback para itens como movimentações iniciais
                movimentacoes = itens.map(item => ({
                    id: item.id,
                    imagem_path: item.imagem_path || './Imagens/placeholder.png',
                    tipo: 'ESTOQUE INICIAL',
                    codigo: item.codigo,
                    nome: item.nome,
                    qtd: item.qtd_inicial,
                    data: new Date().toLocaleString('pt-BR'),
                    obs: item.observacao || '',
                    nf: item.nota_fiscal || '',
                    usuario: currentUser.email || 'Sistema'
                }));
                renderMovimentacoes();
            }
        }

        function populateSetorOptions() {
            const select = document.getElementById('movimentacaoType');
            // Simulação de setores baseados nos itens (substitua por uma chamada à API se necessário)
            const setores = [...new Set(itens.map(item => item.setor))];
            setores.forEach(setor => {
                const option = document.createElement('option');
                option.value = setor;
                option.textContent = setor;
                select.appendChild(option);
            });
        }

        function renderMovimentacoes(filteredMovimentacoes = movimentacoes) {
            const tbody = document.getElementById('movimentacoesBody');
            tbody.innerHTML = filteredMovimentacoes.map(mov => `
                <tr>
                    <td><img src="./Imagens/${mov.imagem_path || 'placeholder.png'}" alt="Item" class="item-img" onerror="this.src='./Imagens/placeholder.png'; this.onerror=null;"></td>
                    <td>${mov.tipo}</td>
                    <td>${mov.codigo}</td>
                    <td>${mov.nome}</td>
                    <td>${mov.qtd}</td>
                    <td>${mov.data}</td>
                    <td>${mov.obs || ''}</td>
                    <td>${mov.nf || ''}</td>
                    <td>${mov.usuario || ''}</td>
                </tr>
            `).join('');
        }

        function filterByDate() {
            // Implementação fictícia - adicione um input de data para filtrar
            alert('Filtrar por Data (implementar input de data)');
        }

        function filterByExits() {
            const filtered = movimentacoes.filter(mov => mov.tipo === 'SAÍDA');
            renderMovimentacoes(filtered);
        }

        function clearFilters() {
            renderMovimentacoes();
            document.getElementById('movimentacaoSearch').value = '';
            document.getElementById('movimentacaoType').value = '';
        }

        function filterMovimentacoes() {
            const query = document.getElementById('movimentacaoSearch').value.toLowerCase();
            const tipo = document.getElementById('movimentacaoType').value;
            let filtered = movimentacoes;

            if (query) {
                filtered = filtered.filter(mov =>
                    (mov.codigo && mov.codigo.toLowerCase().includes(query)) ||
                    (mov.nome && mov.nome.toLowerCase().includes(query)) ||
                    (mov.usuario && mov.usuario.toLowerCase().includes(query))
                );
            }
            if (tipo) {
                filtered = filtered.filter(mov => {
                    const item = itens.find(i => i.codigo === mov.codigo);
                    return item && item.setor === tipo;
                });
            }
            renderMovimentacoes(filtered);
        }

        function exportVisible() {
            const rows = document.querySelectorAll('#movimentacoesTable tbody tr');
            let csv = 'Imagem,Tipo,Código,Nome,Qtd,Data,Obs.,NF,Usuário\n';
            rows.forEach(row => {
                const cols = row.querySelectorAll('td');
                const img = cols[0].querySelector('img').src;
                const tipo = cols[1].textContent;
                const codigo = cols[2].textContent;
                const nome = cols[3].textContent;
                const qtd = cols[4].textContent;
                const data = cols[5].textContent;
                const obs = cols[6].textContent;
                const nf = cols[7].textContent;
                const usuario = cols[8].textContent;
                csv += `"${img}",${tipo},${codigo},${nome},${qtd},${data},${obs},${nf},${usuario}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'movimentacoes.csv';
            a.click();
        }

        // Código que depende de DOM pronto
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar currentUser a partir do localStorage
            currentUser = JSON.parse(localStorage.getItem('loggedUser'));
            if (!currentUser || !currentUser.email) {
                currentUser = { name: 'Lucas Pacheco', email: 'lucas.pacheco@senairs.org.br', role: 'admin' }; // Nome explícito como exemplo
                localStorage.setItem('loggedUser', JSON.stringify(currentUser));
                console.log('Default user set in localStorage:', currentUser);
            }
            console.log('Current User from LocalStorage:', currentUser);

            // Atualizar o nome do usuário na saudação
            const userNameSpan = document.getElementById('userName');
            userNameSpan.textContent = currentUser.name || currentUser.email.split('@')[0]; // Usa name se existir, senão o e-mail sem domínio

            const gerenciarBtn = document.getElementById('gerenciarUsuariosBtn');
            console.log('Gerenciar Usuários Button:', gerenciarBtn);

            if (currentUser && currentUser.role === 'admin') {
                console.log('User is Admin, setting button to display: block');
                gerenciarBtn.style.display = 'block';
            } else {
                console.log('User is not Admin, keeping button display: none');
            }

            // Event listeners para preview de imagem no cadastro
            document.getElementById('imagem').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('previewImg').src = e.target.result;
                        document.getElementById('imagemPreview').style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Event listeners para preview de imagem na edição
            document.getElementById('editImagem').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('editPreviewImg').src = e.target.result;
                        document.getElementById('editImagemPreview').style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Event listener para submit do formulário novo item
            document.getElementById('novoItemForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const formData = new FormData();
                formData.append('codigo', document.getElementById('codigo').value);
                formData.append('setor', document.getElementById('setor').value);
                formData.append('nome', document.getElementById('nome').value);
                formData.append('complemento', document.getElementById('complemento').value);
                formData.append('unidade', document.getElementById('unidade').value);
                formData.append('qtdInicial', document.getElementById('qtdInicial').value);
                formData.append('qtdMinima', document.getElementById('qtdMinima').value || 0);
                formData.append('observacao', document.getElementById('observacao').value);
                formData.append('fornecedor', document.getElementById('fornecedor').value);
                formData.append('notaFiscal', document.getElementById('notaFiscal').value);
                const imagemFile = document.getElementById('imagem').files[0];
                if (imagemFile) {
                    formData.append('imagem', imagemFile);
                }
                formData.append('requesterEmail', currentUser.email);

                try {
                    const response = await fetch('http://localhost:3000/api/add-item', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    console.log('Resposta do servidor:', data); // Debug

                    if (data.success) {
                        document.getElementById('novoItemMsg').textContent = data.message;
                        document.getElementById('novoItemMsg').style.color = 'green';
                        closeNovoItemModal();
                        loadItens(); // Recarrega a tabela
                    } else {
                        document.getElementById('novoItemMsg').textContent = data.message || 'Erro no cadastro';
                        document.getElementById('novoItemMsg').style.color = 'red';
                    }
                } catch (error) {
                    console.error('Erro no submit:', error);
                    document.getElementById('novoItemMsg').textContent = 'Erro de conexão. Verifique o servidor.';
                    document.getElementById('novoItemMsg').style.color = 'red';
                }
            });

            // Event listener para submit do formulário de edição
            document.getElementById('editItemForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const id = document.getElementById('editItemModal').dataset.itemId;
                const formData = new FormData();
                formData.append('id', id);
                formData.append('codigo', document.getElementById('editCodigo').value);
                formData.append('setor', document.getElementById('editSetor').value);
                formData.append('nome', document.getElementById('editNome').value);
                formData.append('complemento', document.getElementById('editComplemento').value);
                formData.append('unidade', document.getElementById('editUnidade').value);
                formData.append('qtdInicial', document.getElementById('editQtdInicial').value);
                formData.append('qtdMinima', document.getElementById('editQtdMinima').value || 0);
                formData.append('observacao', document.getElementById('editObservacao').value);
                formData.append('fornecedor', document.getElementById('editFornecedor').value);
                formData.append('notaFiscal', document.getElementById('editNotaFiscal').value);
                const editImagemFile = document.getElementById('editImagem').files[0];
                if (editImagemFile) {
                    formData.append('imagem', editImagemFile);
                }
                formData.append('requesterEmail', currentUser.email);

                try {
                    const response = await fetch('http://localhost:3000/api/update-item', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    console.log('Resposta do servidor:', data);

                    if (data.success) {
                        document.getElementById('editItemMsg').textContent = data.message;
                        document.getElementById('editItemMsg').style.color = 'green';
                        closeEditItemModal();
                        loadItens(); // Recarrega a tabela
                    } else {
                        document.getElementById('editItemMsg').textContent = data.message || 'Erro na edição';
                        document.getElementById('editItemMsg').style.color = 'red';
                    }
                } catch (error) {
                    console.error('Erro na edição:', error);
                    document.getElementById('editItemMsg').textContent = 'Erro de conexão. Verifique o servidor.';
                    document.getElementById('editItemMsg').style.color = 'red';
                }
            });

            // Event listener para submit do formulário de edição de usuário
            document.getElementById('editUserForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const email = document.getElementById('editUserModal').dataset.userEmail;
                const newRole = document.getElementById('editUserRole').value;
                try {
                    const response = await fetch('http://localhost:3000/api/update-user-role', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, newRole, requesterEmail: currentUser.email })
                    });
                    const data = await response.json();
                    if (data.success) {
                        document.getElementById('editUserMsg').textContent = data.message;
                        document.getElementById('editUserMsg').style.color = 'green';
                        closeEditUserModal();
                        loadUsers();
                    } else {
                        document.getElementById('editUserMsg').textContent = data.message || 'Erro ao editar role';
                        document.getElementById('editUserMsg').style.color = 'red';
                    }
                } catch (error) {
                    document.getElementById('editUserMsg').textContent = 'Erro de conexão. Verifique o servidor.';
                    document.getElementById('editUserMsg').style.color = 'red';
                }
            });

            // Event listener para o modal de estoque
            const stockModal = document.getElementById('stockEntryModal');
            stockModal.addEventListener('click', function(e) {
                if (e.target.classList.contains('confirm-btn')) {
                    if (stockModal.dataset.action === 'remove') {
                        confirmRemoveStock();
                    } else {
                        confirmStockEntry();
                    }
                }
            });

            // Event listener para submit do formulário de registro de usuário
            document.getElementById('registerForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const newEmail = document.getElementById('newEmail').value;
                const newPassword = document.getElementById('newPassword').value;
                const newRole = document.getElementById('newRole').value;
                const requesterEmail = currentUser.email;

                try {
                    const response = await fetch('http://localhost:3000/api/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: newEmail, password: newPassword, role: newRole, requesterEmail })
                    });
                    const data = await response.json();

                    if (data.success) {
                        document.getElementById('registerMsg').textContent = data.message;
                        document.getElementById('registerMsg').style.color = 'green';
                        document.getElementById('registerForm').reset();
                        loadUsers(); // Recarrega a lista após cadastro
                    } else {
                        document.getElementById('registerMsg').textContent = data.message || 'Erro no cadastro';
                        document.getElementById('registerMsg').style.color = 'red';
                    }
                } catch (error) {
                    document.getElementById('registerMsg').textContent = 'Erro de conexão. Verifique o servidor.';
                    document.getElementById('registerMsg').style.color = 'red';
                }
            });

            loadItens(); // Carrega itens da API ou mock
        });

        async function loadItens() {
            try {
                const response = await fetch('http://localhost:3000/api/itens');
                itens = await response.json();
                console.log('Itens carregados do DB:', itens); // Debug dos itens recebidos
            } catch (error) {
                console.error('Erro ao carregar itens:', error);
                itens = [
                    { id: 1, imagem_path: placeholderImg, codigo: '561651651', setor: 'Aços e barras', nome: 'barra de aço', complemento: 'nenhum', unidade: 'UN', qtd_inicial: 10, qtd_minima: 5 },
                    { id: 2, imagem_path: placeholderImg, codigo: '654654645', setor: 'Aços e barras', nome: 'Barra de ferro', complemento: 'nada', unidade: 'UN', qtd_inicial: 5, qtd_minima: 10 }
                ];
                console.log('Usando itens mock:', itens); // Debug do mock
            }
            renderTable();
        }

        function renderTable(filteredItens = itens) {
            const tbody = document.getElementById('tableBody');
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageItens = filteredItens.slice(start, end);

            tbody.innerHTML = pageItens.map(item => {
                console.log('Rendering item:', item); // Debug do item sendo renderizado
                console.log('Image path:', item.imagem_path); // Debug do caminho da imagem
                const isUser = currentUser.role === 'user';
                return `
                    <tr>
                        <td><img src="/${item.imagem_path || placeholderImg}" alt="Item" class="item-img" onerror="this.src='${placeholderImg}'; console.log('Image load failed, using placeholder:', '${item.imagem_path}')"></td>
                        <td>${item.codigo}</td>
                        <td>${item.setor}</td>
                        <td>${item.nome}</td>
                        <td>${item.complemento}</td>
                        <td>${item.unidade}</td>
                        <td class="${item.qtd_inicial <= item.qtd_minima ? 'quantidade-minima' : ''}">
                            ${item.qtd_inicial}
                        </td>
                        <td>
                            <button class="action-btn" onclick="openRemoveStockModal(${item.id})">Baixa</button>
                            <button class="action-btn ${isUser ? 'disabled' : ''}" onclick="openStockEntryModal(${item.id})">Entrada</button>
                            <button class="action-btn ${isUser ? 'disabled' : ''}" onclick="openEditItemModal(${item.id})">Editar</button>
                            ${currentUser.role === 'admin' ? `
                                <button class="btn-excluir" onclick="excluirItem(${item.id})">Excluir</button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            }).join('');

            updatePagination(filteredItens.length);
        }

        async function excluirItem(id) {
            if (currentUser.role !== 'admin') {
                alert('Apenas administradores podem excluir itens.');
                return;
            }
            if (!confirm("Tem certeza que deseja excluir este item?")) {
                return;
            }
            try {
                const response = await fetch('http://localhost:3000/api/delete-item', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ itemId: id, requesterEmail: currentUser.email })
                });
                const data = await response.json();
                console.log('Resposta do servidor:', data);

                if (data.success) {
                    alert(data.message);
                    loadItens(); // Recarrega a tabela
                } else {
                    alert(data.message || 'Erro ao excluir item');
                }
            } catch (error) {
                console.error('Erro ao excluir item:', error);
                alert('Erro de conexão. Verifique o servidor.');
            }
        }

        function filterTable() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const filtered = itens.filter(item => 
                (item.codigo && item.codigo.toLowerCase().includes(query)) ||
                (item.nome && item.nome.toLowerCase().includes(query)) ||
                (item.setor && item.setor.toLowerCase().includes(query)) ||
                (item.complemento && item.complemento.toLowerCase().includes(query))
            );
            currentPage = 1;
            renderTable(filtered);
        }

        function updatePagination(total) {
            const totalPages = Math.ceil(total / itemsPerPage);
            document.getElementById('pageInfo').textContent = `Página ${currentPage} de ${totalPages}`;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages;
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(itens.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        }
    </script>
</body>
</html>